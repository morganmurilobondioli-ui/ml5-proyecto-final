<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad B - Login con Canvas</title>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- p5 y ml5 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.0/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
</head>
<body class="bg-light"> <!-- Fondo claro -->
    <div class="container mt-5">
        <a href="index.html" class="btn btn-secondary mb-4">‚Üê Volver al men√∫</a>
        
        <div class="row justify-content-center">
            <div class="col-md-6">
                <h2 class="text-center mb-4">üîê Login con Canvas</h2>
                
                <div class="card shadow-sm">
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="usuario" class="form-label">Usuario</label>
                                <input type="text" class="form-control" id="usuario" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="password" class="form-label">Contrase√±a</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Dibuja tu c√≥digo de seguridad</label>
                                <div id="canvas-container" class="d-flex justify-content-center mb-2"></div>
                                <div id="real-time-result" class="alert alert-info text-center">
                                    Cargando modelo...
                                </div>
                                <button type="button" class="btn btn-warning w-100 mb-2" onclick="limpiarCanvas()">Limpiar Canvas</button>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">Iniciar Sesi√≥n</button>
                        </form>
                        
                        <div id="resultado" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <strong>Usuarios registrados:</strong><br>
                    ‚Ä¢ juan / 123 / apple<br>
                    ‚Ä¢ maria / 456 / chair<br>
                    ‚Ä¢ pedro / 789 / house
                </div>
            </div>
        </div>
    </div>

    <script>
        // Array de usuarios registrados
        const usuarios = [
            { usuario: "juan", password: "123", dibujo: "apple" },
            { usuario: "maria", password: "456", dibujo: "chair" },
            { usuario: "pedro", password: "789", dibujo: "house" }
        ];

        let classifier;
        let canvas;
        let currentResults = [];

        function preload() {
            // Usar DoodleNet para reconocer dibujos
            classifier = ml5.imageClassifier("DoodleNet");
        }

        function setup() {
            canvas = createCanvas(480, 480)
            canvas.parent("canvas-container");
            background(255);
            
            // Clasificaci√≥n en tiempo real
            classifier.classifyStart(canvas, gotResult);
        }

        function draw(){
            strokeWeight(24)  //Grosor l√°piz
            stroke(0)         //Color trazo

            if (mouseIsPressed){
                //p = pressed
                line(pmouseX, pmouseY, mouseX, mouseY)
            }
        }

        function gotResult(results) {
            currentResults = results;
            
            // Mostrar resultado en tiempo real
            const realtimeDiv = document.getElementById("real-time-result");
            if (results && results.length > 0) {
                const label = results[0].label;
                const confidence = (results[0].confidence * 100).toFixed(1);
                realtimeDiv.innerHTML = `Detectando: <strong>${label}</strong> (${confidence}%)`;
            }
        }

        function limpiarCanvas() {
            background(255);
            currentResults = [];
            const realtimeDiv = document.getElementById("real-time-result");
            realtimeDiv.innerHTML = 'Dibuja algo...';
        }

        // Manejar login
        document.getElementById("loginForm").addEventListener("submit", function(e) {
            e.preventDefault();
            
            const usuario = document.getElementById("usuario").value;
            const password = document.getElementById("password").value;
            const resultadoDiv = document.getElementById("resultado");
            
            // Buscar usuario
            const usuarioEncontrado = usuarios.find(u => u.usuario === usuario && u.password === password);
            
            if (!usuarioEncontrado) {
                resultadoDiv.innerHTML = '<div class="alert alert-danger">Usuario o contrase√±a incorrectos</div>';
                return;
            }
            
            if (!currentResults || currentResults.length === 0) {
                resultadoDiv.innerHTML = '<div class="alert alert-warning">Por favor dibuja algo en el canvas</div>';
                return;
            }
            
            // Verificar el dibujo
            const mejorPrediccion = currentResults[0];
            const confianza = mejorPrediccion.confidence * 100;
            const etiqueta = mejorPrediccion.label.toLowerCase();
            const dibujoEsperado = usuarioEncontrado.dibujo.toLowerCase();
            
            console.log("Esperado:", dibujoEsperado, "Detectado:", etiqueta, "Confianza:", confianza);
            
            // Verificar coincidencia con 75% de confianza
            if (etiqueta === dibujoEsperado && confianza >= 75) {
                resultadoDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ Login exitoso!</h5>
                        <p><strong>Usuario:</strong> ${usuario}</p>
                        <p><strong>Dibujo detectado:</strong> ${mejorPrediccion.label}</p>
                        <p><strong>Confianza:</strong> ${confianza.toFixed(2)}%</p>
                    </div>
                `;
            } else {
                // Mostrar top 3 predicciones
                let predicciones = currentResults.slice(0, 3).map((r, i) => 
                    `${i+1}. ${r.label} (${(r.confidence * 100).toFixed(2)}%)`
                ).join('<br>');
                
                resultadoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Dibujo no v√°lido</h5>
                        <p><strong>Esperado:</strong> ${usuarioEncontrado.dibujo}</p>
                        <p><strong>Detectado:</strong> ${mejorPrediccion.label}</p>
                        <p><strong>Confianza:</strong> ${confianza.toFixed(2)}%</p>
                        <p class="mt-2"><strong>Top 3 predicciones:</strong></p>
                        <p>${predicciones}</p>
                        <p class="mt-2"><small>Se requiere m√≠nimo 75% de confianza</small></p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>