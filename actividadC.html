<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad C - Reconocimiento en Tiempo Real</title>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Solo ml5 -->
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <a href="index.html" class="btn btn-secondary mb-4">‚Üê Volver al men√∫</a>
        
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2 class="text-center mb-4">üéØ Reconocimiento de Objetos en Tiempo Real</h2>
                <p class="text-center lead">Muestra objetos a la c√°mara para identificarlos</p>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center">
                        <button id="startButton" class="btn btn-primary btn-lg" onclick="iniciarCamara()">
                            Iniciar C√°mara
                        </button>
                        
                        <!-- Video de la c√°mara -->
                        <div class="d-flex justify-content-center mt-3">
                            <video id="webcam" autoplay playsinline style="max-width: 100%; border-radius: 10px; display: none;"></video>
                        </div>
                    </div>
                </div>
                
                <!-- Tarjeta de resultados -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Resultados en Tiempo Real</h5>
                        <div id="results-container" class="text-start">
                            <p class="text-muted">Presiona "Iniciar C√°mara" para comenzar</p>
                        </div>
                    </div>
                </div>

                <!-- Controles de s√≠ntesis de voz -->
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="card-title">üîä Sintetizador de Voz</h5>
                        
                        <div class="mb-3">
                            <label for="voices" class="form-label">Voz</label>
                            <select class="form-select" id="voices">
                                <option value="">Seleccione una voz</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="pitch" class="form-label">Tono: <span id="pitch-value">1</span></label>
                            <input type="range" class="form-range" min="0" max="2" step="0.25" value="1" id="pitch">
                        </div>

                        <div class="mb-3">
                            <label for="rate" class="form-label">Velocidad: <span id="rate-value">1</span></label>
                            <input type="range" class="form-range" min="0" max="2" step="0.25" value="1" id="rate">
                        </div>

                        <div class="mb-3">
                            <label for="volume" class="form-label">Volumen: <span id="volume-value">1</span></label>
                            <input type="range" class="form-range" min="0" max="1" step="0.1" value="1" id="volume">
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="speak-btn" onclick="hablar()">üîä Hablar</button>
                            <button class="btn btn-warning" id="cancel-btn" onclick="cancelar()">üîá Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let classifier;
        let video;
        let currentResults = [];

        // Referencias a elementos
        const voiceOptions = document.getElementById("voices");
        const pitchInput = document.getElementById("pitch");
        const rateInput = document.getElementById("rate");
        const volumeInput = document.getElementById("volume");

        // Actualizar valores mostrados de los sliders
        pitchInput.addEventListener("input", (e) => {
            document.getElementById("pitch-value").textContent = e.target.value;
        });

        rateInput.addEventListener("input", (e) => {
            document.getElementById("rate-value").textContent = e.target.value;
        });

        volumeInput.addEventListener("input", (e) => {
            document.getElementById("volume-value").textContent = e.target.value;
        });

        // Cargar voces disponibles
        function cargarVoces() {
            const voices = speechSynthesis.getVoices();
            if (voices.length > 0) {
                voiceOptions.innerHTML = voices.map((voice, index) => {
                    return `<option value='${index}'>${voice.name} (${voice.lang})</option>`;
                }).join("");
            }
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = cargarVoces;
        }
        setTimeout(cargarVoces, 100);

        async function iniciarCamara() {
            const startButton = document.getElementById("startButton");
            const resultsContainer = document.getElementById("results-container");
            
            startButton.disabled = true;
            resultsContainer.innerHTML = '<p class="text-info">Iniciando c√°mara...</p>';
            
            try {
                // Obtener acceso a la c√°mara
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                
                video = document.getElementById("webcam");
                video.srcObject = stream;
                video.style.display = "block";
                
                resultsContainer.innerHTML = '<p class="text-info">Cargando modelo...</p>';
                
                // Cargar el clasificador
                classifier = await ml5.imageClassifier("MobileNet", video);
                
                resultsContainer.innerHTML = '<p class="text-success">Clasificando objetos...</p>';
                
                // Iniciar clasificaci√≥n
                clasificarContinuo();
                
            } catch (error) {
                console.error("Error:", error);
                resultsContainer.innerHTML = '<p class="text-danger">Error al acceder a la c√°mara</p>';
                startButton.disabled = false;
            }
        }

        async function clasificarContinuo() {
            if (!classifier || !video) return;
            
            try {
                const results = await classifier.classify(video);
                mostrarResultados(results);
                
                // Continuar clasificando
                setTimeout(clasificarContinuo, 1000);
            } catch (error) {
                console.error("Error en clasificaci√≥n:", error);
            }
        }

        function mostrarResultados(results) {
            console.log("Resultados:", results);
            currentResults = results;
            
            const container = document.getElementById("results-container");
            container.innerHTML = "";

            if (!results || results.length === 0) {
                container.innerHTML = '<p class="text-muted">No se detectaron objetos</p>';
                return;
            }

            // Mostrar top 3
            results.slice(0, 3).forEach((res, i) => {
                const porcentaje = (res.confidence * 100).toFixed(2);

                const label = document.createElement("p");
                label.classList.add("fw-semibold", "mb-1", "mt-3");
                label.innerText = `${i + 1}. ${res.label} (${porcentaje}%)`;

                const progressDiv = document.createElement("div");
                progressDiv.classList.add("progress", "mb-2");
                progressDiv.style.height = "25px";

                const progressBar = document.createElement("div");
                progressBar.classList.add("progress-bar", "progress-bar-striped", "progress-bar-animated", "bg-success");
                progressBar.style.width = `${porcentaje}%`;

                progressDiv.appendChild(progressBar);
                container.appendChild(label);
                container.appendChild(progressDiv);
            });
        }

        function hablar() {
            if (!currentResults || currentResults.length === 0) {
                alert("No hay resultados para leer. Por favor inicia la c√°mara primero.");
                return;
            }

            const mejorResultado = currentResults[0];
            const confianza = (mejorResultado.confidence * 100).toFixed(0);
            const texto = `Objeto detectado: ${mejorResultado.label}. Confianza: ${confianza} por ciento`;

            const message = new SpeechSynthesisUtterance(texto);
            const index = voiceOptions.selectedIndex;

            if (index >= 0 && speechSynthesis.getVoices().length > 0) {
                message.voice = speechSynthesis.getVoices()[index];
            }
            
            message.pitch = parseFloat(pitchInput.value);
            message.rate = parseFloat(rateInput.value);
            message.volume = parseFloat(volumeInput.value);
            message.lang = 'es-ES';

            speechSynthesis.speak(message);
        }

        function cancelar() {
            speechSynthesis.cancel();
        }
    </script>
</body>
</html>