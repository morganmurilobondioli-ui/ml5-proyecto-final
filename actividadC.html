<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad 3 - Modelo Personalizado</title>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Teachable Machine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    
    <style>
        .training-card {
            transition: transform 0.2s;
        }
        .training-card:hover {
            transform: scale(1.05);
        }
        .object-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-light">

    <div class="container mt-5">
        <a href="index.html" class="btn btn-secondary mb-4">‚Üê Volver al men√∫</a>
        
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h2 class="text-center mb-4">üéì Reconocimiento con Modelo Personalizado</h2>
                <p class="text-center lead">Modelo entrenado con Teachable Machine para 5 objetos espec√≠ficos</p>
                
                <div class="p-3 mb-4 rounded bg-white shadow-sm border">
                    <h5 class="text-center mb-3">üìö Objetos Entrenados</h5>
                    <div class="d-flex justify-content-center flex-wrap gap-4" style="font-size: 1.1rem;">
                        <span>üì± Tel√©fono</span>
                        <span>‚å®Ô∏è Teclado</span>
                        <span>üñ±Ô∏è Mouse</span>
                        <span>üîë Llave</span>
                        <span>ü™™ DNI</span>
                    </div>
                </div>

                <div class="card shadow-sm">
                    
                    <div class="card-body text-center">
                        <button id="startButton" class="btn btn-primary btn-lg" onclick="iniciarCamara()">
                            üé• Iniciar Reconocimiento
                        </button>
                        
                        <div id="webcam-container" class="mt-3 bg-dark rounded" style="min-height: 50px;">
                            </div>

                        <div id="status" class="mt-3">
                            <p class="text-muted">Presiona el bot√≥n para comenzar</p>
                        </div>
                    </div>

                    <div class="card-body border-top">
                        <h5 class="card-title text-center">üìä Resultados en Tiempo Real</h5>
                        <div id="results-container" class="text-start pt-2" style="min-height: 80px;">
                            <p class="text-muted text-center">Esperando detecci√≥n...</p>
                        </div>
                    </div>

                    <div class="card-footer bg-light">
                        <div class="accordion" id="voiceAccordion">
                            <div class="accordion-item border-0 bg-light">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVoice" aria-expanded="false" aria-controls="collapseVoice">
                                        üîä Opciones de Sintetizador de Voz
                                    </button>
                                </h2>
                                <div id="collapseVoice" class="accordion-collapse collapse" data-bs-parent="#voiceAccordion">
                                    <div class="accordion-body">
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="voices" class="form-label">Voz</label>
                                                <select class="form-select" id="voices">
                                                    <option value="">Seleccione una voz</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="pitch" class="form-label">Tono: <span id="pitch-value">1</span></label>
                                                <input type="range" class="form-range" min="0" max="2" step="0.25" value="1" id="pitch">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="rate" class="form-label">Velocidad: <span id="rate-value">1</span></label>
                                                <input type="range" class="form-range" min="0" max="2" step="0.25" value="1" id="rate">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="volume" class="form-label">Volumen: <span id="volume-value">1</span></label>
                                                <input type="range" class="form-range" min="0" max="1" step="0.1" value="1" id="volume">
                                            </div>
                                        </div>

                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <button class="btn btn-success" id="speak-btn" onclick="hablar()">üîä Reproducir Resultado</button>
                                            <button class="btn btn-warning" id="cancel-btn" onclick="cancelar()">üîá Cancelar</button>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> </div> </div>
        </div>
    </div>

    <script>
        // URL del modelo de Teachable Machine (carpeta local)
        const URL = "./my_model/";

        let model, webcam, maxPredictions;
        let currentResults = [];
        let isRunning = false;

        // Referencias a elementos
        const voiceOptions = document.getElementById("voices");
        const pitchInput = document.getElementById("pitch");
        const rateInput = document.getElementById("rate");
        const volumeInput = document.getElementById("volume");
        const statusDiv = document.getElementById("status");

        // ... (El resto de tu JavaScript sigue aqu√≠ sin ning√∫n cambio) ...
        // ... (cargarVoces, iniciarCamara, loop, predict, mostrarResultados, hablar, cancelar) ...

        // Cargar voces
        function cargarVoces() {
            const voices = speechSynthesis.getVoices();
            if (voices.length > 0) {
                voiceOptions.innerHTML = voices.map((voice, index) => {
                    // Filtrar para mostrar solo voces en espa√±ol (opcional, pero √∫til)
                    if (voice.lang.startsWith('es-')) {
                         return `<option value='${index}'>${voice.name} (${voice.lang})</option>`;
                    }
                    return '';
                }).join("");
                
                // Si no hay voces en espa√±ol, mostrar todas
                if (voiceOptions.innerHTML === "") {
                     voiceOptions.innerHTML = voices.map((voice, index) => {
                        return `<option value='${index}'>${voice.name} (${voice.lang})</option>`;
                    }).join("");
                }
            }
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = cargarVoces;
        }
        setTimeout(cargarVoces, 100);

        // Actualizar valores de sliders
        pitchInput.addEventListener("input", (e) => {
            document.getElementById("pitch-value").textContent = e.target.value;
        });

        rateInput.addEventListener("input", (e) => {
            document.getElementById("rate-value").textContent = e.target.value;
        });

        volumeInput.addEventListener("input", (e) => {
            document.getElementById("volume-value").textContent = e.target.value;
        });

        async function iniciarCamara() {
            const startButton = document.getElementById("startButton");
            const webcamContainer = document.getElementById("webcam-container");
            const resultsContainer = document.getElementById("results-container");
            
            if (isRunning) {
                // Detener webcam
                if (webcam) {
                    webcam.stop();
                }
                isRunning = false;
                startButton.innerHTML = 'üé• Iniciar Reconocimiento';
                startButton.classList.remove('btn-danger');
                startButton.classList.add('btn-primary');
                startButton.disabled = false;
                webcamContainer.innerHTML = ''; // Limpia el canvas
                statusDiv.innerHTML = '<p class="text-muted">Sistema detenido</p>';
                resultsContainer.innerHTML = '<p class="text-muted text-center">Esperando detecci√≥n...</p>';
                return;
            }
            
            startButton.disabled = true;
            startButton.innerHTML = '‚è≥ Cargando...';
            
            statusDiv.innerHTML = '<p class="text-info">‚è≥ Cargando modelo...</p>';
            
            try {
                // Cargar el modelo
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                
                statusDiv.innerHTML = '<p class="text-info">üìπ Iniciando c√°mara...</p>';
                
                // Configurar webcam
                const flip = true;
                webcam = new tmImage.Webcam(400, 400, flip); // Un tama√±o m√°s cuadrado
                await webcam.setup(); // solicitar acceso a la c√°mara
                await webcam.play();
                
                // Agregar el canvas al contenedor
                webcamContainer.innerHTML = '';
                webcamContainer.appendChild(webcam.canvas);
                webcam.canvas.style.maxWidth = '100%';
                webcam.canvas.style.maxHeight = '400px';
                webcam.canvas.style.borderRadius = '10px';
                
                statusDiv.innerHTML = '<p class="text-success">‚úÖ Sistema activo - Mostrando objetos...</p>';
                
                isRunning = true;
                startButton.disabled = false;
                startButton.innerHTML = '‚èπÔ∏è Detener';
                startButton.classList.remove('btn-primary');
                startButton.classList.add('btn-danger'); // Bot√≥n rojo para detener
                
                // Iniciar predicci√≥n
                loop();
                
            } catch (error) {
                console.error("Error:", error);
                let errorMsg = '';
                
                const errorMessage = (error && error.message) ? error.message : String(error);
                
                if (errorMessage.includes('denied') || errorMessage.includes('camera')) {
                    errorMsg = '‚ùå Error: No se pudo acceder a la c√°mara.<br><small>‚Ä¢ Verifica que hayas dado permisos de c√°mara al navegador<br>‚Ä¢ Revisa la configuraci√≥n de privacidad de tu navegador<br>‚Ä¢ Aseg√∫rate de que ninguna otra aplicaci√≥n est√© usando la c√°mara</small>';
                } else if (errorMessage.includes('model') || errorMessage.includes('fetch')) {
                    errorMsg = `‚ùå Error: No se pudo cargar el modelo.<br><small>‚Ä¢ Aseg√∫rate de que la carpeta "my_model" est√© en el mismo directorio<br>‚Ä¢ Verifica que contenga: model.json, metadata.json y weights.bin<br>‚Ä¢ Usa un servidor local (Live Server, Python http.server, etc.)</small>`;
                } else {
                    errorMsg = `‚ùå Error: ${errorMessage}`;
                }
                
                statusDiv.innerHTML = `<div class="alert alert-danger">${errorMsg}</div>`;
                startButton.disabled = false;
                startButton.innerHTML = 'üé• Iniciar Reconocimiento';
                startButton.classList.add('btn-primary');
                startButton.classList.remove('btn-danger');
                isRunning = false;
            }
        }

        async function loop() {
            if (!isRunning || !webcam) return;
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            if (!model || !webcam) return;
            const prediction = await model.predict(webcam.canvas);
            mostrarResultados(prediction);
        }

        function mostrarResultados(predictions) {
            currentResults = predictions.sort((a, b) => b.probability - a.probability);
            
            const container = document.getElementById("results-container");
            container.innerHTML = "";

            if (!predictions || predictions.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No se detectaron objetos</p>';
                return;
            }

            // Mostrar todas las predicciones
            currentResults.forEach((pred, i) => {
                const porcentaje = (pred.probability * 100).toFixed(2);
                
                let colorClass = "bg-success";
                if (pred.probability < 0.3) colorClass = "bg-danger";
                else if (pred.probability < 0.6) colorClass = "bg-warning";

                const label = document.createElement("p");
                label.classList.add("fw-semibold", "mb-1", "mt-3");
                
                // Agregar emoji de trofeo si es la mejor predicci√≥n con alta confianza
                const emoji = (i === 0 && pred.probability > 0.6) ? 'üèÜ' : '';
                
                label.innerText = `${emoji} ${pred.className} (${porcentaje}%)`;

                const progressDiv = document.createElement("div");
                progressDiv.classList.add("progress", "mb-2");
                progressDiv.style.height = "25px";

                const progressBar = document.createElement("div");
                progressBar.classList.add("progress-bar", "progress-bar-striped", colorClass);
                if (i === 0) progressBar.classList.add("progress-bar-animated");
                progressBar.style.width = `${porcentaje}%`;
                progressBar.setAttribute('aria-valuenow', porcentaje);
                progressBar.setAttribute('aria-valuemin', 0);
                progressBar.setAttribute('aria-valuemax', 100);

                progressDiv.appendChild(progressBar);
                container.appendChild(label);
                container.appendChild(progressDiv);
            });
        }

        function hablar() {
            if (!currentResults || currentResults.length === 0) {
                alert("No hay resultados para leer. Por favor inicia la c√°mara primero.");
                return;
            }

            const mejorResultado = currentResults[0];
            const confianza = (mejorResultado.probability * 100).toFixed(0);
            
            let texto;
            if (mejorResultado.probability > 0.8) { // Aumentar el umbral de confianza
                texto = `Objeto detectado: ${mejorResultado.className}. Confianza: ${confianza} por ciento.`;
            } else if (mejorResultado.probability > 0.5) {
                texto = `Posible objeto: ${mejorResultado.className}. Confianza: ${confianza} por ciento.`;
            } else {
                texto = `No se puede identificar con certeza.`;
            }

            const message = new SpeechSynthesisUtterance(texto);
            const allVoices = speechSynthesis.getVoices();
            
            if (allVoices.length > 0) {
                 // Tratar de encontrar una voz en espa√±ol autom√°ticamente
                let spanishVoice = allVoices.find(v => v.lang.startsWith('es-'));
                
                // Si el usuario seleccion√≥ una, usar esa
                const selectedIndex = voiceOptions.value;
                if (selectedIndex) {
                    message.voice = allVoices[selectedIndex];
                } else if (spanishVoice) {
                    message.voice = spanishVoice; // Usar la primera voz en espa√±ol encontrada
                }
                // Si no, usur√° la voz por defecto del navegador
            }

            message.pitch = parseFloat(pitchInput.value);
            message.rate = parseFloat(rateInput.value);
            message.volume = parseFloat(volumeInput.value);

            speechSynthesis.cancel(); // Cancelar cualquier habla en curso
            speechSynthesis.speak(message);
        }

        function cancelar() {
            speechSynthesis.cancel();
        }

    </script>
</body>
</html>